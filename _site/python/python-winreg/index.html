<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>python winreg模块 • CapeskyChung</title>
    <meta name="description" content="_winreg用法，python用于操作windows注册表模块.

">
    <meta name="keywords" content="winreg, python">
    
    	<!-- Twitter Cards -->
	<meta name="twitter:title" content="python winreg模块">
	<meta name="twitter:description" content="_winreg用法，python用于操作windows注册表模块.

">
	
	
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:image" content="/images/">
	
	<!-- Open Graph -->
	<meta property="og:locale" content="en">
	<meta property="og:type" content="article">
	<meta property="og:title" content="python winreg模块">
	<meta property="og:description" content="_winreg用法，python用于操作windows注册表模块.

">
	<meta property="og:url" content="/python/python-winreg/">
	<meta property="og:site_name" content="CapeskyChung">

    <link rel="canonical" href="/python/python-winreg/">

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="CapeskyChung Atom Feed">
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cleartype" content="on">

    <link rel="stylesheet" href="/css/main.css">
    <!-- HTML5 Shiv and Media Query Support for IE -->
    <!--[if lt IE 9]>
      <script src="/js/vendor/html5shiv.min.js"></script>
      <script src="/js/vendor/respond.min.js"></script>
    <![endif]-->

  </head>

  <body id="js-body">
    <!--[if lt IE 9]><div class="upgrade notice-warning"><strong>Your browser is quite old!</strong> Why not <a href="http://whatbrowser.org/">upgrade to a newer one</a> to better enjoy this site?</div><![endif]-->

    <header id="masthead">
  <div class="inner-wrap">
    <a href="/" class="site-title">CapeskyChung</a>
    <nav role="navigation" class="menu top-menu">
        <ul class="menu-item">
	<li class="home"><a href="/">CapeskyChung</a></li>
	
    
    <li><a href="/" >Home</a></li>
  
    
    <li><a href="/python/" >Python</a></li>
  
    
    <li><a href="/linux/" >Linux</a></li>
  
    
    <li><a href="/algorithm/" >Algorithm</a></li>
  
    
    <li><a href="/ai/" >AI</a></li>
  
    
    <li><a href="/database/" >Database</a></li>
  
    
    <li><a href="/about/" >About Me</a></li>
  
</ul>
    </nav>
  </div><!-- /.inner-wrap -->
</header><!-- /.masthead -->
    <nav role="navigation" id="js-menu" class="sliding-menu-content">
  <h5>CapeskyChung <span>Table of Contents</span></h5>
  <ul class="menu-item">
    <li>
      <a href="/">
        <img src="/images/sunny-sunset-morning.jpg" alt="teaser" class="teaser">
        <div class="title">Home</div>
        
      </a>
    </li><li>
      <a href="/python/">
        
        <div class="title">Python</div>
        
      </a>
    </li><li>
      <a href="/linux/">
        
        <div class="title">Linux</div>
        
      </a>
    </li><li>
      <a href="/algorithm/">
        
        <div class="title">Algorithm</div>
        
      </a>
    </li><li>
      <a href="/ai/">
        
        <div class="title">AI</div>
        
      </a>
    </li><li>
      <a href="/database/">
        
        <div class="title">Database</div>
        
      </a>
    </li><li>
      <a href="/about/">
        
        <div class="title">About Me</div>
        
      </a>
    </li>
  </ul>
</nav>
<button type="button" id="js-menu-trigger" class="sliding-menu-button lines-button x2" role="button" aria-label="Toggle Navigation">
  <span class="nav-lines"></span>
</button>

<div id="js-menu-screen" class="menu-screen"></div>


    <div id="page-wrapper">
      <div id="main" role="main">
	<article class="wrap" itemscope itemtype="http://schema.org/Article">
		
		
  <nav class="breadcrumbs">
    <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
      <a href="" itemprop="url">
        <span itemprop="title">Home</span>
      </a> › 
    <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
      <a href="/python/" itemprop="url">
        <span itemprop="title">Python</span>
      </a>
    </span>
  </nav><!-- /.breadcrumbs -->

		<div class="page-title">
			<h1>python winreg模块</h1>
		</div>
		<div class="inner-wrap">
			<div id="content" class="page-content" itemprop="articleBody">
				<p>_winreg用法，python用于操作windows注册表模块.</p>

<h4 id="createkey">CreateKey</h4>
<p>参数1： obKey 注册表key对象 <br />
参数2：subKey 字符串对象，子key的名称</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyCreateKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="n">HKEY</span> <span class="n">retKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oz:CreateKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegCreateKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retKey</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"CreateKey"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyHKEY_FromHKEY</span><span class="p">(</span><span class="n">retKey</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">_winreg</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">_winreg</span><span class="o">.</span><span class="n">CreateKey</span><span class="p">(</span><span class="n">_winreg</span><span class="o">.</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span> <span class="s">r"Software</span><span class="se">\\</span><span class="s">Extensions"</span><span class="p">)</span></code></pre></figure>

<h4 id="createkeyex">CreateKeyEx</h4>
<p>参数1： obKey 注册表键对象 <br />
参数2：subKey 字符串，健名称 <br />
参数3：res  <br />
参数4： sam 表示访问权限</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyCreateKeyEx</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="n">HKEY</span> <span class="n">retKey</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">REGSAM</span> <span class="n">sam</span> <span class="o">=</span> <span class="n">KEY_WRITE</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oz|ii:CreateKeyEx"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">,</span>
                                              <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sam</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegCreateKeyEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
                                            <span class="n">sam</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"CreateKeyEx"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyHKEY_FromHKEY</span><span class="p">(</span><span class="n">retKey</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<h4 id="deletekey">DeleteKey</h4>
<p>参数1：已经打开的key <br />
参数2：需要删除的key的名称，不能为None，key可能没有子key <br />
方法不能删除带有子key的keys。删除成功的话，整个key包含值回忆起被删掉，如果失败，会有一个WindowsError异常</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyDeleteKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Os:DeleteKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegDeleteKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegDeleteKey"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="deletekeyex">DeleteKeyEx</h4>
<p>参数1：obKey<br />
参数2：需要删除的子key，字符串类型，不能为None，可能没有subkeys<br />
参数3: sam访问权限，可无<br />
参数4：res预留字段，必须为0，默认值为0，可无</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyDeleteKeyEx</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="n">HMODULE</span> <span class="n">hMod</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">LONG</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">RDKEFunc</span><span class="p">)(</span><span class="n">HKEY</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="n">REGSAM</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
    <span class="n">RDKEFunc</span> <span class="n">pfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">REGSAM</span> <span class="n">sam</span> <span class="o">=</span> <span class="n">KEY_WOW64_64KEY</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Os|ii:DeleteKeyEx"</span><span class="p">,</span>
                                              <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Only available on 64bit platforms, so we must load it
       dynamically. */</span>
    <span class="n">hMod</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"advapi32.dll"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hMod</span><span class="p">)</span>
        <span class="n">pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">RDKEFunc</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hMod</span><span class="p">,</span>
                                                                   <span class="s">"RegDeleteKeyExA"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_NotImplementedError</span><span class="p">,</span>
                                        <span class="s">"not implemented on this platform"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pfn</span><span class="p">)(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="n">sam</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegDeleteKeyEx"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="deletevalue">DeleteValue</h4>
<p>参数1：一个已经打开的key<br />
参数2：value 字符串</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyDeleteValue</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oz:DeleteValue"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegDeleteValue</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span><span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegDeleteValue"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="connectregistry">ConnectRegistry</h4>
<p>在另一台机器上建立一个预定义的注册表句柄连接，返回一个句柄对象。  <br />
参数1： 另外一台机器的ip或者机器名  <br />
参数2： 一个要打开的key  ，必须是HKEY_CURRENT_USER,HKEY_LOCAL_MACHINE等预先定义好的值，拿到返回的key后就可以进行操作</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyConnectRegistry</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">szCompName</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">HKEY</span> <span class="n">retKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"zO:ConnectRegistry"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">szCompName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegConnectRegistry</span><span class="p">(</span><span class="n">szCompName</span><span class="p">,</span> <span class="n">hKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retKey</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"ConnectRegistry"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyHKEY_FromHKEY</span><span class="p">(</span><span class="n">retKey</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">_winreg</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">_winreg</span><span class="o">.</span><span class="n">ConnectRegisty</span><span class="p">(</span><span class="s">"IP地址或者机器名"</span><span class="p">,</span> <span class="n">_winreg</span><span class="o">.</span><span class="n">HKEY_CURRENT_USER</span><span class="p">)</span></code></pre></figure>

<h4 id="disablereflectionkey">DisableReflectionKey</h4>
<p>禁止一个32位的进程运行在64位的操作系统上时注册表的映射</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyDisableReflectionKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="n">HMODULE</span> <span class="n">hMod</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">LONG</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">RDRKFunc</span><span class="p">)(</span><span class="n">HKEY</span><span class="p">);</span>
    <span class="n">RDRKFunc</span> <span class="n">pfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">LONG</span> <span class="n">rc</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"O:DisableReflectionKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Only available on 64bit platforms, so we must load it
       dynamically. */</span>
    <span class="n">hMod</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"advapi32.dll"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hMod</span><span class="p">)</span>
        <span class="n">pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">RDRKFunc</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hMod</span><span class="p">,</span>
                                       <span class="s">"RegDisableReflectionKey"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_NotImplementedError</span><span class="p">,</span>
                        <span class="s">"not implemented on this platform"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pfn</span><span class="p">)(</span><span class="n">hKey</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegDisableReflectionKey"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="enablereflectionkey">EnableReflectionKey</h4>
<p>为指定的残值回复注册表反射</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyEnableReflectionKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="n">HMODULE</span> <span class="n">hMod</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">LONG</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">RERKFunc</span><span class="p">)(</span><span class="n">HKEY</span><span class="p">);</span>
    <span class="n">RERKFunc</span> <span class="n">pfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">LONG</span> <span class="n">rc</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"O:EnableReflectionKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Only available on 64bit platforms, so we must load it
       dynamically. */</span>
    <span class="n">hMod</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"advapi32.dll"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hMod</span><span class="p">)</span>
        <span class="n">pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">RERKFunc</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hMod</span><span class="p">,</span>
                                       <span class="s">"RegEnableReflectionKey"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_NotImplementedError</span><span class="p">,</span>
                        <span class="s">"not implemented on this platform"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pfn</span><span class="p">)(</span><span class="n">hKey</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegEnableReflectionKey"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="enumkey">EnumKey</h4>
<p>枚举子key
参数1：已经打开的key <br />
参数2：子key的索引</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyEnumKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">retStr</span><span class="p">;</span>

    <span class="cm">/* The Windows docs claim that the max key name length is 255
     * characters, plus a terminating nul character.  However,
     * empirical testing demonstrates that it is possible to
     * create a 256 character key that is missing the terminating
     * nul.  RegEnumKeyEx requires a 257 character buffer to
     * retrieve such a key name. */</span>
    <span class="kt">char</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">257</span><span class="p">];</span>
    <span class="n">DWORD</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span> <span class="cm">/* includes NULL terminator */</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oi:EnumKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegEnumKeyEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegEnumKeyEx"</span><span class="p">);</span>

    <span class="n">retStr</span> <span class="o">=</span> <span class="n">PyString_FromStringAndSize</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">retStr</span><span class="p">;</span>  <span class="cm">/* can be NULL */</span>
<span class="p">}</span></code></pre></figure>

<h4 id="enumvalue">EnumValue</h4>
<p>枚举一个打开的注册表key，返回一个tuple <br />
参数1： 一个打开的注册表key <br />
参数2：key中注册表值的索引</p>

<table>
  <thead>
    <tr>
      <th>Index</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>value名称</td>
    </tr>
    <tr>
      <td>1</td>
      <td>值</td>
    </tr>
    <tr>
      <td>2</td>
      <td>值的类型</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyEnumValue</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">retValueBuf</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">retDataBuf</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tmpBuf</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">retValueSize</span><span class="p">,</span> <span class="n">bufValueSize</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">retDataSize</span><span class="p">,</span> <span class="n">bufDataSize</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">typ</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obData</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">retVal</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oi:EnumValue"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">RegQueryInfoKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                              <span class="nb">NULL</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">retValueSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retDataSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
        <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegQueryInfoKey"</span><span class="p">);</span>
    <span class="o">++</span><span class="n">retValueSize</span><span class="p">;</span>    <span class="cm">/* include null terminators */</span>
    <span class="o">++</span><span class="n">retDataSize</span><span class="p">;</span>
    <span class="n">bufDataSize</span> <span class="o">=</span> <span class="n">retDataSize</span><span class="p">;</span>
    <span class="n">bufValueSize</span> <span class="o">=</span> <span class="n">retValueSize</span><span class="p">;</span>
    <span class="n">retValueBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">PyMem_Malloc</span><span class="p">(</span><span class="n">retValueSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retValueBuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_NoMemory</span><span class="p">();</span>
    <span class="n">retDataBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">PyMem_Malloc</span><span class="p">(</span><span class="n">retDataSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retDataBuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retValueBuf</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PyErr_NoMemory</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_BEGIN_ALLOW_THREADS</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">RegEnumValue</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span>
                  <span class="n">index</span><span class="p">,</span>
                  <span class="n">retValueBuf</span><span class="p">,</span>
                  <span class="o">&amp;</span><span class="n">retValueSize</span><span class="p">,</span>
                  <span class="nb">NULL</span><span class="p">,</span>
                  <span class="o">&amp;</span><span class="n">typ</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">retDataBuf</span><span class="p">,</span>
                  <span class="o">&amp;</span><span class="n">retDataSize</span><span class="p">);</span>
        <span class="n">Py_END_ALLOW_THREADS</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_MORE_DATA</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">bufDataSize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">tmpBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">PyMem_Realloc</span><span class="p">(</span><span class="n">retDataBuf</span><span class="p">,</span> <span class="n">bufDataSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tmpBuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_NoMemory</span><span class="p">();</span>
            <span class="n">retVal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">retDataBuf</span> <span class="o">=</span> <span class="n">tmpBuf</span><span class="p">;</span>
        <span class="n">retDataSize</span> <span class="o">=</span> <span class="n">bufDataSize</span><span class="p">;</span>
        <span class="n">retValueSize</span> <span class="o">=</span> <span class="n">bufValueSize</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">retVal</span> <span class="o">=</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                     <span class="s">"PyRegEnumValue"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">obData</span> <span class="o">=</span> <span class="n">Reg2Py</span><span class="p">(</span><span class="n">retDataBuf</span><span class="p">,</span> <span class="n">retDataSize</span><span class="p">,</span> <span class="n">typ</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obData</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">retVal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">retVal</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">"sOi"</span><span class="p">,</span> <span class="n">retValueBuf</span><span class="p">,</span> <span class="n">obData</span><span class="p">,</span> <span class="n">typ</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">obData</span><span class="p">);</span>
  <span class="nl">fail:</span>
    <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retValueBuf</span><span class="p">);</span>
    <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retDataBuf</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">_winreg</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">_winreg</span><span class="o">.</span><span class="n">OpenKey</span><span class="p">(</span><span class="n">_winreg</span><span class="o">.</span><span class="n">HKEY_CURRENT_KEY</span><span class="p">,</span> <span class="s">r"Netease</span><span class="err">\</span><span class="s">txm"</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">vtype</span> <span class="o">=</span> <span class="n">_winreg</span><span class="o">.</span><span class="n">EnumValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
	<span class="k">pass</span></code></pre></figure>

<h4 id="expandenvironmentstrings">ExpandEnvironmentStrings</h4>
<p>展开环境变量中的引用</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyExpandEnvironmentStrings</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_UNICODE</span> <span class="o">*</span><span class="n">retValue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_UNICODE</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">retValueSize</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">o</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"u:ExpandEnvironmentStrings"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">retValueSize</span> <span class="o">=</span> <span class="n">ExpandEnvironmentStringsW</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">retValue</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retValueSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">retValueSize</span><span class="p">,</span>
                                        <span class="s">"ExpandEnvironmentStrings"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">retValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">Py_UNICODE</span> <span class="o">*</span><span class="p">)</span><span class="n">PyMem_Malloc</span><span class="p">(</span><span class="n">retValueSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Py_UNICODE</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retValue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">PyErr_NoMemory</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">ExpandEnvironmentStringsW</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">retValue</span><span class="p">,</span> <span class="n">retValueSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retValue</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">retValueSize</span><span class="p">,</span>
                                        <span class="s">"ExpandEnvironmentStrings"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">PyUnicode_FromUnicode</span><span class="p">(</span><span class="n">retValue</span><span class="p">,</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">retValue</span><span class="p">));</span>
    <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retValue</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">ExpandEnvironmentStrings</span><span class="p">(</span><span class="s">u"</span><span class="si">%</span><span class="s">windir</span><span class="si">%</span><span class="s">"</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="s">"C:</span><span class="se">\\</span><span class="s">Windows"</span></code></pre></figure>

<h4 id="flushkey">FlushKey</h4>
<p>将key的所有属性全部写入注册表 <br />
参数1：已经打开的key</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyFlushKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"O:FlushKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegFlushKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegFlushKey"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="loadkey">LoadKey</h4>
<p>参数1：一个已经打开的key <br />
参数2：需要操作的子key的名称 <br />
参数3：文件名称 <br />
从指定的文件中读入子健的信息</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyLoadKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">;</span>

    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oss:LoadKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fileName</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegLoadKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="n">fileName</span> <span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegLoadKey"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="openkey">OpenKey</h4>
<p>参数1: 一个已经打开的key，注册表有六大健根， HKEY_USERS, HKEY_CURRENT_USE,HKEY_CURRENT_CONFIG,HKEY_CLASSES_ROOT,HKEY_LOCAL_MACHINE, HKEY_DYN_DATA <br />
参数2: 需要操作的子健 <br />
参数3: 必须为0 <br />
参数4：sam，默认为只读模式，蚕蛹的有KEY_ALL_ACCESS, KEY_WRITE, KEY_READ访问权限，默认为只读</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyOpenKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">HKEY</span> <span class="n">retKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">REGSAM</span> <span class="n">sam</span> <span class="o">=</span> <span class="n">KEY_READ</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oz|ii:OpenKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sam</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">sam</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retKey</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegOpenKeyEx"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyHKEY_FromHKEY</span><span class="p">(</span><span class="n">retKey</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<h4 id="openkeyex">OpenKeyEx</h4>
<p>跟接口OpenKey一致</p>

<h4 id="closekey">CloseKey</h4>
<p>关闭一个打开的key<br />
参数1： 一个打开的注册表key</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyCloseKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"O:CloseKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_Close</span><span class="p">(</span><span class="n">obKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="queryvalue">QueryValue</h4>
<p>在注册表中检索一个健的路径<br />
注册表值有名字，类型，和数据值。这个方法找回一个key的第一个值（名字为NULL）但是API调用的时候不会回type，因此一般用QueryValueEx()</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyQueryValue</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">retStr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">retBuf</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">bufSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">retSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oz:QueryValue"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegQueryValue</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ERROR_MORE_DATA</span><span class="p">)</span>
        <span class="n">retSize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegQueryValue"</span><span class="p">);</span>

    <span class="n">bufSize</span> <span class="o">=</span> <span class="n">retSize</span><span class="p">;</span>
    <span class="n">retBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyMem_Malloc</span><span class="p">(</span><span class="n">bufSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retBuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_NoMemory</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">retSize</span> <span class="o">=</span> <span class="n">bufSize</span><span class="p">;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">RegQueryValue</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="n">retBuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_MORE_DATA</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">bufSize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyMem_Realloc</span><span class="p">(</span><span class="n">retBuf</span><span class="p">,</span> <span class="n">bufSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retBuf</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">PyErr_NoMemory</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">retBuf</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retBuf</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegQueryValue"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">retBuf</span><span class="p">[</span><span class="n">retSize</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\x00'</span><span class="p">)</span>
        <span class="n">retSize</span><span class="o">--</span><span class="p">;</span>
    <span class="n">retStr</span> <span class="o">=</span> <span class="n">PyString_FromStringAndSize</span><span class="p">(</span><span class="n">retBuf</span><span class="p">,</span> <span class="n">retSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retStr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retBuf</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">retStr</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="queryvalueex">QueryValueEx</h4>
<p>找到一个注册表key下的某个指定名字的type和数据值。 <br />
参数1： key一个已经打开的注册表key <br />
参数2：value_name是一个要查询到注册表值得名字<br />
返回的是一个2个值得tuple</p>

<table>
  <thead>
    <tr>
      <th>Index</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>注册表项的值</td>
    </tr>
    <tr>
      <td>1</td>
      <td>注册表值得类型</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyQueryValueEx</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">valueName</span><span class="p">;</span>

    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">retBuf</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">bufSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retSize</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">typ</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obData</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Oz:QueryValueEx"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valueName</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">valueName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ERROR_MORE_DATA</span><span class="p">)</span>
        <span class="n">bufSize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegQueryValueEx"</span><span class="p">);</span>
    <span class="n">retBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">PyMem_Malloc</span><span class="p">(</span><span class="n">bufSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retBuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_NoMemory</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">retSize</span> <span class="o">=</span> <span class="n">bufSize</span><span class="p">;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">valueName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">typ</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">retBuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_MORE_DATA</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">bufSize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">PyMem_Realloc</span><span class="p">(</span><span class="n">retBuf</span><span class="p">,</span> <span class="n">bufSize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retBuf</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">PyErr_NoMemory</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">retBuf</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">retBuf</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegQueryValueEx"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">obData</span> <span class="o">=</span> <span class="n">Reg2Py</span><span class="p">(</span><span class="n">retBuf</span><span class="p">,</span> <span class="n">bufSize</span><span class="p">,</span> <span class="n">typ</span><span class="p">);</span>
    <span class="n">PyMem_Free</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">retBuf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obData</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">"Oi"</span><span class="p">,</span> <span class="n">obData</span><span class="p">,</span> <span class="n">typ</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">obData</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="queryinfokey">QueryInfoKey</h4>
<p>返回一个key的信息，返回类型是tuple<br />
参数1： 一个打开的key</p>

<p>返回结果是一个3个值得tuple</p>

<table>
  <tbody>
    <tr>
      <td>Index</td>
      <td>Meaning</td>
    </tr>
    <tr>
      <td>0</td>
      <td>一个整型，表示key有多少子key</td>
    </tr>
    <tr>
      <td>1</td>
      <td>一个整型，表示key有多少个值</td>
    </tr>
    <tr>
      <td>2</td>
      <td>一个长整型，代表上次修改的时间</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyQueryInfoKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
  <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">nSubKeys</span><span class="p">,</span> <span class="n">nValues</span><span class="p">;</span>
  <span class="n">FILETIME</span> <span class="n">ft</span><span class="p">;</span>
  <span class="n">LARGE_INTEGER</span> <span class="n">li</span><span class="p">;</span>
  <span class="n">PyObject</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
  <span class="n">PyObject</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"O:QueryInfoKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">RegQueryInfoKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nSubKeys</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">nValues</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ft</span><span class="p">))</span>
      <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegQueryInfoKey"</span><span class="p">);</span>
  <span class="n">li</span><span class="p">.</span><span class="n">LowPart</span> <span class="o">=</span> <span class="n">ft</span><span class="p">.</span><span class="n">dwLowDateTime</span><span class="p">;</span>
  <span class="n">li</span><span class="p">.</span><span class="n">HighPart</span> <span class="o">=</span> <span class="n">ft</span><span class="p">.</span><span class="n">dwHighDateTime</span><span class="p">;</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">PyLong_FromLongLong</span><span class="p">(</span><span class="n">li</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">"iiO"</span><span class="p">,</span> <span class="n">nSubKeys</span><span class="p">,</span> <span class="n">nValues</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
  <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="queryreflectionkey">QueryReflectionKey</h4>
<p>查询一个key的反射状态<br />
参数1： 一个打开的注册表key <br />
返回True的话表示反射被禁止  <br />
在32位的操作系统上会抛出NotImplemented异常</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyQueryReflectionKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="n">HMODULE</span> <span class="n">hMod</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">LONG</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">RQRKFunc</span><span class="p">)(</span><span class="n">HKEY</span><span class="p">,</span> <span class="n">BOOL</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">RQRKFunc</span> <span class="n">pfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">LONG</span> <span class="n">rc</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"O:QueryReflectionKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Only available on 64bit platforms, so we must load it
       dynamically. */</span>
    <span class="n">hMod</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"advapi32.dll"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hMod</span><span class="p">)</span>
        <span class="n">pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">RQRKFunc</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hMod</span><span class="p">,</span>
                                       <span class="s">"RegQueryReflectionKey"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_NotImplementedError</span><span class="p">,</span>
                        <span class="s">"not implemented on this platform"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pfn</span><span class="p">)(</span><span class="n">hKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegQueryReflectionKey"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PyBool_FromLong</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<h4 id="savekey">SaveKey</h4>
<p>参数1： 一个打开的注册表key<br />
参数2： 文件名称<br />
保存一个指key和它的所有的子key到文件中。需要管理员权限<br />
参考： https://stackoverflow.com/questions/30984406/winreg-savekey-error-a-required-privilege-is-not-held-by-the-client</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PySaveKey</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">;</span>
    <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">pSA</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"Os:SaveKey"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fileName</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cm">/*  One day we may get security into the core?
    if (!PyWinObject_AsSECURITY_ATTRIBUTES(obSA, &amp;pSA, TRUE))
        return NULL;
*/</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegSaveKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">pSA</span> <span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegSaveKey"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="setvalue">SetValue</h4>
<p>关联一个key与值 <br />
参数1： 一个打开的注册表key <br />
参数2： subkey的名称<br />
参数3： 类型<br />
参数4： 新的值，子key的默认值  <br />
设置之后类似于文件夹的子文件夹</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PySetValue</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">subKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">typ</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obStrVal</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obSubKey</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"OOiO:SetValue"</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">obSubKey</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">typ</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">obStrVal</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">typ</span> <span class="o">!=</span> <span class="n">REG_SZ</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span>
                        <span class="s">"Type must be _winreg.REG_SZ"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* XXX - need Unicode support */</span>
    <span class="n">str</span> <span class="o">=</span> <span class="n">PyString_AsString</span><span class="p">(</span><span class="n">obStrVal</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">PyString_Size</span><span class="p">(</span><span class="n">obStrVal</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obSubKey</span> <span class="o">==</span> <span class="n">Py_None</span><span class="p">)</span>
        <span class="n">subKey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">subKey</span> <span class="o">=</span> <span class="n">PyString_AsString</span><span class="p">(</span><span class="n">obSubKey</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegSetValue</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">subKey</span><span class="p">,</span> <span class="n">REG_SZ</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">"RegSetValue"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="setvalueex">SetValueEx</h4>
<p>关一个key与值 <br />
参数1： 一个已经打开的注册表的key<br />
参数2： subkey的名字字符串，子keyw的值关联。<br />
参数3： 值得类型  <br />
参数4： res默认值为0<br />
参数5： value，注册表值得具体内容 <br />
关系类似于文件夹下的文件。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PySetValueEx</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obKey</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">valueName</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">obRes</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
    <span class="n">BYTE</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">len</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">typ</span><span class="p">;</span>

    <span class="n">LONG</span> <span class="n">rc</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"OzOiO:SetValueEx"</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">obKey</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">valueName</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">obRes</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">typ</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyHKEY_AsHKEY</span><span class="p">(</span><span class="n">obKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Py2Reg</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyErr_Occurred</span><span class="p">())</span>
            <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_ValueError</span><span class="p">,</span>
                     <span class="s">"Could not convert the data to the specified type."</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_BEGIN_ALLOW_THREADS</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">RegSetValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">valueName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">Py_END_ALLOW_THREADS</span>
    <span class="n">PyMem_DEL</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromWindowsErrWithFunction</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span>
                                                   <span class="s">"RegSetValueEx"</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">Py_None</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>REG_NONE 0 <br />
REG_SZ 1 <br />
REG_EXPAND_SZ 2 <br />
REG_BINARY 3 <br />
REG_DWORD 4 <br />
REG_DWORD_LITTLE_ENDIAN 4 <br />
REG_DWORD_BIG_ENDIAN 5 <br />
REG_LINK 6 <br />
REG_MULTI_SZ 7  <br />
REG_RESOURCE_LIST 8 <br />
REG_FULL_RESOURCE_DESCRIPTOR 9 <br />
REG_RESOURCE_REQUIREMENTS_LIST 10  <br />
REG_QWORD 11 <br />
REG_QWORD_LITLE_ENDIAN 12</p>

<p>参考：https://docs.python.org/2/library/_winreg.html</p>

				<hr />
				<footer class="page-footer">
					

<div class="author-image">
	<img src="/images/bio-photo.jpg" alt="capeskychung">
</div><!-- ./author-image -->
<div class="author-content">
	<h3 class="author-name" >Written by <span itemprop="author">capeskychung</span></h3>
	<p class="author-bio"></p>
</div><!-- ./author-content -->
					<div class="inline-btn">
	<a class="btn-social twitter" href="https://twitter.com/intent/tweet?text=python%20winreg模块&amp;url=/python/python-winreg/&amp;via=" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i> Share on Twitter</a>
	<a class="btn-social facebook" href="https://www.facebook.com/sharer/sharer.php?u=/python/python-winreg/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i> Share on Facebook</a>
	<a class="btn-social google-plus"  href="https://plus.google.com/share?url=/python/python-winreg/" target="_blank"><i class="fa fa-google-plus" aria-hidden="true"></i> Share on Google+</a>
</div><!-- /.share-this -->

					<div class="page-meta">
	<p>Updated <time datetime="2018-03-25T18:04:00Z" itemprop="datePublished">March 25, 2018</time></p>
</div><!-- /.page-meta -->
				</footer><!-- /.footer -->
				<aside>
					
				</aside>
			</div><!-- /.content -->
		</div><!-- /.inner-wrap -->
		
	</article><!-- ./wrap -->
</div><!-- /#main -->

      <footer role="contentinfo" id="site-footer">
	<nav role="navigation" class="menu bottom-menu">
		<ul class="menu-item">
		
      
			<li><a href="" ></a></li>
		
		</ul>
	</nav><!-- /.bottom-menu -->
	<p class="copyright">&#169; 2018 <a href="">CapeskyChung</a> powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> + <a href="http://mmistakes.github.io/skinny-bones-jekyll/" rel="nofollow">Skinny Bones</a>.</p>
</footer>
    </div>

    <script src="/js/vendor/jquery-1.9.1.min.js"></script>
    <script src="/js/main.js"></script>

  </body>

</html>
